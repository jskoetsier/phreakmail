version: '2.2'

services:
  unbound-phreakmail:
    image: alpine:3.18
    command: >
      sh -c "apk add --no-cache unbound curl &&
             cat > /tmp/unbound.conf <<EOF
      server:
        interface: 0.0.0.0
        access-control: 0.0.0.0/0 allow
        do-ip4: yes
        do-ip6: yes
        do-udp: yes
        do-tcp: yes
      forward-zone:
        name: \".\"
        forward-addr: 8.8.8.8
        forward-addr: 8.8.4.4
      EOF
             touch /tmp/healthy &&
             unbound -c /tmp/unbound.conf -d"
    environment:
      TZ: ${TZ}
      SKIP_UNBOUND_HEALTHCHECK: ${SKIP_UNBOUND_HEALTHCHECK}
    volumes:
      - ./data/hooks/unbound:/hooks:Z
      - ./data/conf/unbound/unbound.conf:/etc/unbound/unbound.conf:ro,Z
    restart: always
    tty: true
    healthcheck:
      test: ["CMD", "test", "-f", "/tmp/healthy"]
      interval: 10s
      timeout: 3s
      retries: 3
    networks:
      phreakmail-network:
        ipv4_address: ${IPV4_NETWORK:-172.22.1}.254
        aliases:
          - unbound

  mysql-phreakmail:
    image: mariadb:10.11
    depends_on:
      - unbound-phreakmail
      - netfilter-phreakmail
    stop_grace_period: 45s
    volumes:
      - mysql-vol-1:/var/lib/mysql/
      - mysql-socket-vol-1:/var/run/mysqld/
      - ./data/conf/mysql/:/etc/mysql/conf.d/:ro,Z
    environment:
      TZ: ${TZ}
      MYSQL_ROOT_PASSWORD: ${DBROOT}
      MYSQL_DATABASE: ${DBNAME}
      MYSQL_USER: ${DBUSER}
      MYSQL_PASSWORD: ${DBPASS}
      MYSQL_INITDB_SKIP_TZINFO: 1
    restart: always
    ports:
      - "127.0.0.1:13306:3306"
    networks:
      phreakmail-network:
        aliases:
          - mysql
          - mysql-phreakmail

  keydb-phreakmail:
    image: eqalpha/keydb:latest
    entrypoint: ["/bin/sh","/keydb-conf.sh"]
    volumes:
      - keydb-vol-1:/data/
      - ./data/conf/keydb/keydb-conf.sh:/keydb-conf.sh:z
    restart: always
    depends_on:
      - netfilter-phreakmail
    ports:
      - "127.0.0.1:7654:6379"
    environment:
      TZ: ${TZ}
      KEYDBPASS: ${KEYDBPASS:-}
      KEYDBMASTERPASS: ${KEYDBMASTERPASS:-}
      KEYDB_THREADS: 4
    sysctls:
      - net.core.somaxconn=4096
    networks:
      phreakmail-network:
        ipv4_address: ${IPV4_NETWORK:-172.22.1}.249
        aliases:
          - keydb
          - keydb-mailcow

  rspamd-phreakmail:
    image: mailcow/rspamd:latest
    stop_grace_period: 30s
    depends_on:
      - dovecot-phreakmail
      - comodo-phreakmail
    environment:
      TZ: ${TZ}
      IPV4_NETWORK: ${IPV4_NETWORK:-172.22.1}
      IPV6_NETWORK: ${IPV6_NETWORK:-fd4d:6169:6c63:6f77::/64}
      KEYDB_SLAVEOF_IP: ${KEYDB_SLAVEOF_IP:-}
      KEYDB_SLAVEOF_PORT: ${KEYDB_SLAVEOF_PORT:-}
      KEYDBPASS: ${KEYDBPASS:-}
      SPAMHAUS_DQS_KEY: ${SPAMHAUS_DQS_KEY:-}
    volumes:
      - ./data/hooks/rspamd:/hooks:Z
      - ./data/conf/rspamd/custom/:/etc/rspamd/custom:z
      - ./data/conf/rspamd/override.d/:/etc/rspamd/override.d:Z
      - ./data/conf/rspamd/local.d/:/etc/rspamd/local.d:Z
      - ./data/conf/rspamd/plugins.d/:/etc/rspamd/plugins.d:Z
      - ./data/conf/rspamd/lua/:/etc/rspamd/lua/:ro,Z
      - ./data/conf/rspamd/rspamd.conf.local:/etc/rspamd/rspamd.conf.local:Z
      - ./data/conf/rspamd/rspamd.conf.override:/etc/rspamd/rspamd.conf.override:Z
      - rspamd-vol-1:/var/lib/rspamd
    restart: always
    hostname: rspamd
    dns:
      - ${IPV4_NETWORK:-172.22.1}.254
    networks:
      phreakmail-network:
        aliases:
          - rspamd

  php-fpm-phreakmail:
    image: mailcow/phpfpm:latest
    entrypoint: ["/custom-entrypoint.sh"]
    command: "php-fpm -d date.timezone=${TZ} -d expose_php=0"
    depends_on:
      - keydb-phreakmail
    volumes:
      - ./custom-entrypoint.sh:/custom-entrypoint.sh:z
      - ./data/hooks/phpfpm:/hooks:Z
      - ./data/web:/web:z
      - ./data/conf/rspamd/dynmaps:/dynmaps:ro,z
      - ./data/conf/rspamd/custom/:/rspamd_custom_maps:z
      - ./data/conf/dovecot/auth/phreakmailauth.php:/phreakmailauth/phreakmailauth.php:z
      - ./data/web/inc/functions.inc.php:/phreakmailauth/functions.inc.php:z
      - ./data/web/inc/functions.auth.inc.php:/phreakmailauth/functions.auth.inc.php:z
      - ./data/web/inc/sessions.inc.php:/phreakmailauth/sessions.inc.php:z
      - ./data/web/inc/functions.mailbox.inc.php:/phreakmailauth/functions.mailbox.inc.php:z
      - ./data/web/inc/functions.ratelimit.inc.php:/phreakmailauth/functions.ratelimit.inc.php:z
      - ./data/web/inc/functions.acl.inc.php:/phreakmailauth/functions.acl.inc.php:z
      - rspamd-vol-1:/var/lib/rspamd
      - mysql-socket-vol-1:/var/run/mysqld/
      - ./data/conf/rspamd/meta_exporter:/meta_exporter:ro,z
      - ./data/conf/phpfpm/crons:/crons:z
      - ./data/conf/phpfpm/sogo-sso/:/etc/sogo-sso/:z
      - ./data/conf/phpfpm/php-fpm.d/pools.conf:/usr/local/etc/php-fpm.d/z-pools.conf:Z
      - ./data/conf/phpfpm/php-conf.d/opcache-recommended.ini:/usr/local/etc/php/conf.d/opcache-recommended.ini:Z
      - ./data/conf/phpfpm/php-conf.d/upload.ini:/usr/local/etc/php/conf.d/upload.ini:Z
      - ./data/conf/phpfpm/php-conf.d/other.ini:/usr/local/etc/php/conf.d/zzz-other.ini:Z
      - ./data/conf/dovecot/global_sieve_before:/global_sieve/before:z
      - ./data/conf/dovecot/global_sieve_after:/global_sieve/after:z
      - ./data/assets/templates:/tpls:z
      - ./data/conf/apache2/:/etc/apache2/conf.d/:z
    dns:
      - ${IPV4_NETWORK:-172.22.1}.254
    environment:
      KEYDB_SLAVEOF_IP: ${KEYDB_SLAVEOF_IP:-}
      KEYDB_SLAVEOF_PORT: ${KEYDB_SLAVEOF_PORT:-}
      KEYDBPASS: ${KEYDBPASS:-}
      LOG_LINES: ${LOG_LINES:-9999}
      TZ: ${TZ}
      DBNAME: ${DBNAME}
      DBUSER: ${DBUSER}
      DBPASS: ${DBPASS}
      PHREAKMAIL_HOSTNAME: ${PHREAKMAIL_HOSTNAME}
      PHREAKMAIL_PASS_SCHEME: ${PHREAKMAIL_PASS_SCHEME:-BLF-CRYPT}
      IMAP_PORT: ${IMAP_PORT:-143}
      IMAPS_PORT: ${IMAPS_PORT:-993}
      POP_PORT: ${POP_PORT:-110}
      POPS_PORT: ${POPS_PORT:-995}
      SIEVE_PORT: ${SIEVE_PORT:-4190}
      IPV4_NETWORK: ${IPV4_NETWORK:-172.22.1}
      IPV6_NETWORK: ${IPV6_NETWORK:-fd4d:6169:6c63:6f77::/64}
      SUBMISSION_PORT: ${SUBMISSION_PORT:-587}
      SMTPS_PORT: ${SMTPS_PORT:-465}
      SMTP_PORT: ${SMTP_PORT:-25}
      API_KEY: ${API_KEY:-invalid}
      API_KEY_READ_ONLY: ${API_KEY_READ_ONLY:-invalid}
      API_ALLOW_FROM: ${API_ALLOW_FROM:-invalid}
      COMPOSE_PROJECT_NAME: ${COMPOSE_PROJECT_NAME:-phreakmail-dockerized}
      SKIP_FTS: ${SKIP_FTS:-y}
      SKIP_CLAMD: ${SKIP_CLAMD:-n}
      SKIP_OLEFY: ${SKIP_OLEFY:-n}
      SKIP_SOGO: ${SKIP_SOGO:-y}
      ALLOW_ADMIN_EMAIL_LOGIN: ${ALLOW_ADMIN_EMAIL_LOGIN:-n}
      MASTER: ${MASTER:-y}
      DEV_MODE: ${DEV_MODE:-n}
      DEMO_MODE: ${DEMO_MODE:-n}
      WEBAUTHN_ONLY_TRUSTED_VENDORS: ${WEBAUTHN_ONLY_TRUSTED_VENDORS:-n}
      CLUSTERMODE: ${CLUSTERMODE:-}
      ADDITIONAL_SERVER_NAMES: ${ADDITIONAL_SERVER_NAMES:-}
    restart: always
    labels:
      ofelia.enabled: "true"
      ofelia.job-exec.phpfpm_keycloak_sync.schedule: "@every 1m"
      ofelia.job-exec.phpfpm_keycloak_sync.no-overlap: "true"
      ofelia.job-exec.phpfpm_keycloak_sync.command: "/bin/bash -c \"php /crons/keycloak-sync.php || exit 0\""
      ofelia.job-exec.phpfpm_ldap_sync.schedule: "@every 1m"
      ofelia.job-exec.phpfpm_ldap_sync.no-overlap: "true"
      ofelia.job-exec.phpfpm_ldap_sync.command: "/bin/bash -c \"php /crons/ldap-sync.php || exit 0\""
    networks:
      phreakmail-network:
        aliases:
          - phpfpm


  dovecot-phreakmail:
    image: alpine:3.18
    command: >
      sh -c "apk add --no-cache dovecot dovecot-mysql &&
             echo 'Dovecot service placeholder running...' &&
             while true; do sleep 3600; done"
    depends_on:
      - mysql-phreakmail
      - netfilter-phreakmail
      - keydb-phreakmail
    dns:
      - ${IPV4_NETWORK:-172.22.1}.254
    cap_add:
      - NET_BIND_SERVICE
    volumes:
      - ./data/hooks/dovecot:/hooks:Z
      - ./data/conf/dovecot:/etc/dovecot:z
      - ./data/assets/ssl:/etc/ssl/mail/:ro,z
      - ./data/conf/phpfpm/sogo-sso/:/etc/phpfpm/:z
      - vmail-vol-1:/var/vmail
      - vmail-index-vol-1:/var/vmail_index
      - crypt-vol-1:/mail_crypt/
      - ./data/conf/rspamd/custom/:/etc/rspamd/custom:z
      - ./data/assets/templates:/templates:z
      - rspamd-vol-1:/var/lib/rspamd
      - mysql-socket-vol-1:/var/run/mysqld/
    environment:
      DOVECOT_MASTER_USER: ${DOVECOT_MASTER_USER:-}
      DOVECOT_MASTER_PASS: ${DOVECOT_MASTER_PASS:-}
      PHREAKMAIL_REPLICA_IP: ${PHREAKMAIL_REPLICA_IP:-}
      DOVEADM_REPLICA_PORT: ${DOVEADM_REPLICA_PORT:-}
      LOG_LINES: ${LOG_LINES:-9999}
      DBNAME: ${DBNAME}
      DBUSER: ${DBUSER}
      DBPASS: ${DBPASS}
      TZ: ${TZ}
      PHREAKMAIL_HOSTNAME: ${PHREAKMAIL_HOSTNAME}
      PHREAKMAIL_PASS_SCHEME: ${PHREAKMAIL_PASS_SCHEME:-BLF-CRYPT}
      IPV4_NETWORK: ${IPV4_NETWORK:-172.22.1}
      ALLOW_ADMIN_EMAIL_LOGIN: ${ALLOW_ADMIN_EMAIL_LOGIN:-n}
      MAILDIR_GC_TIME: ${MAILDIR_GC_TIME:-7200}
      ACL_ANYONE: ${ACL_ANYONE:-disallow}
      SKIP_FTS: ${SKIP_FTS:-y}
      FTS_HEAP: ${FTS_HEAP:-512}
      FTS_PROCS: ${FTS_PROCS:-3}
      MAILDIR_SUB: ${MAILDIR_SUB:-}
      MASTER: ${MASTER:-y}
      KEYDB_SLAVEOF_IP: ${KEYDB_SLAVEOF_IP:-}
      KEYDB_SLAVEOF_PORT: ${KEYDB_SLAVEOF_PORT:-}
      KEYDBPASS: ${KEYDBPASS:-}
      COMPOSE_PROJECT_NAME: ${COMPOSE_PROJECT_NAME:-phreakmail-dockerized}
    ports:
      - "127.0.0.1:19991:12345"
      - "143:143"
      - "993:993"
      - "110:110"
      - "995:995"
      - "4190:4190"
    restart: always
    tty: true
    labels:
      ofelia.enabled: "true"
      ofelia.job-exec.dovecot_imapsync_runner.schedule: "@every 1m"
      ofelia.job-exec.dovecot_imapsync_runner.no-overlap: "true"
      ofelia.job-exec.dovecot_imapsync_runner.command: "/bin/bash -c \"[[ $${MASTER} == y ]] && /usr/local/bin/gosu nobody /usr/local/bin/imapsync_runner.pl || exit 0\""
      ofelia.job-exec.dovecot_trim_logs.schedule: "@every 1m"
      ofelia.job-exec.dovecot_trim_logs.command: "/bin/bash -c \"[[ $${MASTER} == y ]] && /usr/local/bin/gosu vmail /usr/local/bin/trim_logs.sh || exit 0\""
      ofelia.job-exec.dovecot_quarantine.schedule: "@every 20m"
      ofelia.job-exec.dovecot_quarantine.command: "/bin/bash -c \"[[ $${MASTER} == y ]] && /usr/local/bin/gosu vmail /usr/local/bin/quarantine_notify.py || exit 0\""
      ofelia.job-exec.dovecot_clean_q_aged.schedule: "@every 24h"
      ofelia.job-exec.dovecot_clean_q_aged.command: "/bin/bash -c \"[[ $${MASTER} == y ]] && /usr/local/bin/gosu vmail /usr/local/bin/clean_q_aged.sh || exit 0\""
      ofelia.job-exec.dovecot_maildir_gc.schedule: "@every 30m"
      ofelia.job-exec.dovecot_maildir_gc.command: "/bin/bash -c \"source /source_env.sh ; /usr/local/bin/gosu vmail /usr/local/bin/maildir_gc.sh\""
      ofelia.job-exec.dovecot_sarules.schedule: "@every 24h"
      ofelia.job-exec.dovecot_sarules.command: "/bin/bash -c \"/usr/local/bin/sa-rules.sh\""
      ofelia.job-exec.dovecot_fts.schedule: "@every 24h"
      ofelia.job-exec.dovecot_fts.command: "/bin/bash -c \"/usr/local/bin/gosu vmail /usr/local/bin/optimize-fts.sh\""
      ofelia.job-exec.dovecot_repl_health.schedule: "@every 5m"
      ofelia.job-exec.dovecot_repl_health.command: "/bin/bash -c \"/usr/local/bin/gosu vmail /usr/local/bin/repl_health.sh\""
    ulimits:
      nproc: 65535
      nofile:
        soft: 20000
        hard: 40000
    networks:
      phreakmail-network:
        ipv4_address: ${IPV4_NETWORK:-172.22.1}.250
        aliases:
          - dovecot

  exim-phreakmail:
    image: debian:bullseye-slim
    command: >
      sh -c "apt-get update && apt-get install -y exim4 exim4-daemon-heavy exim4-config mailutils openssl ca-certificates &&
             mkdir -p /etc/exim4/conf.d &&
             touch /var/log/exim4/mainlog &&
             echo 'Configuring Exim...' &&
             update-exim4.conf.template -r &&
             service exim4 start &&
             tail -f /var/log/exim4/mainlog"
    depends_on:
      mysql-phreakmail:
        condition: service_started
      unbound-phreakmail:
        condition: service_healthy
    volumes:
      - ./data/hooks/exim:/hooks:Z
      - ./data/conf/exim:/etc/exim4/conf.d:z
      - ./data/assets/ssl:/etc/ssl/mail/:ro,z
      - exim-vol-1:/var/spool/exim4
      - crypt-vol-1:/var/lib/zeyple
      - rspamd-vol-1:/var/lib/rspamd
      - mysql-socket-vol-1:/var/run/mysqld/
    environment:
      LOG_LINES: ${LOG_LINES:-9999}
      TZ: ${TZ}
      DBNAME: ${DBNAME}
      DBUSER: ${DBUSER}
      DBPASS: ${DBPASS}
      KEYDB_SLAVEOF_IP: ${KEYDB_SLAVEOF_IP:-}
      KEYDB_SLAVEOF_PORT: ${KEYDB_SLAVEOF_PORT:-}
      KEYDBPASS: ${KEYDBPASS:-}
      PHREAKMAIL_HOSTNAME: ${PHREAKMAIL_HOSTNAME}
      SPAMHAUS_DQS_KEY: ${SPAMHAUS_DQS_KEY:-}
    cap_add:
      - NET_BIND_SERVICE
    ports:
      - "25:25"
      - "465:465"
      - "587:587"
    restart: always
    dns:
      - ${IPV4_NETWORK:-172.22.1}.254
    networks:
      phreakmail-network:
        ipv4_address: ${IPV4_NETWORK:-172.22.1}.253
        aliases:
          - exim

  memcached-phreakmail:
    image: memcached:alpine
    restart: always
    environment:
      TZ: ${TZ}
    networks:
      phreakmail-network:
        aliases:
          - memcached

  apache2-phreakmail:
    depends_on:
      - keydb-phreakmail
      - php-fpm-phreakmail
      - rspamd-phreakmail
    image: httpd:2.4-alpine
    dns:
      - ${IPV4_NETWORK:-172.22.1}.254
    environment:
      HTTPS_PORT: ${HTTPS_PORT:-443}
      HTTP_PORT: ${HTTP_PORT:-80}
      PHREAKMAIL_HOSTNAME: ${PHREAKMAIL_HOSTNAME}
      ADDITIONAL_SERVER_NAMES: ${ADDITIONAL_SERVER_NAMES:-}
      TZ: ${TZ}
      SKIP_RSPAMD: ${SKIP_RSPAMD:-n}
      DISABLE_IPv6: ${DISABLE_IPv6:-n}
      HTTP_REDIRECT: ${HTTP_REDIRECT:-n}
      PHPFPMHOST: ${PHPFPMHOST:-}
      RSPAMDHOST: ${RSPAMDHOST:-}
      KEYDBHOST: ${KEYDBHOST:-}
      IPV4_NETWORK: ${IPV4_NETWORK:-172.22.1}
      APACHE_USE_PROXY_PROTOCOL: ${APACHE_USE_PROXY_PROTOCOL:-n}
      TRUSTED_PROXIES: ${TRUSTED_PROXIES:-}
    volumes:
      - ./data/web:/web:ro,z
      - ./data/conf/rspamd/dynmaps:/dynmaps:ro,z
      - ./data/assets/ssl/:/etc/ssl/mail/:ro,z
      - ./data/conf/apache2/:/usr/local/apache2/conf/extra/:z
      - ./data/conf/rspamd/meta_exporter:/meta_exporter:ro,z
      - ./data/conf/dovecot/auth/phreakmailauth.php:/phreakmailauth/phreakmailauth.php:z
      - ./data/web/inc/functions.inc.php:/phreakmailauth/functions.inc.php:z
      - ./data/web/inc/functions.auth.inc.php:/phreakmailauth/functions.auth.inc.php:z
      - ./data/web/inc/sessions.inc.php:/phreakmailauth/sessions.inc.php:z
    ports:
      - "443:443"
      - "80:80"
    restart: always
    networks:
      phreakmail-network:
        aliases:
          - apache2

  acme-phreakmail:
    depends_on:
      apache2-phreakmail:
        condition: service_started
      unbound-phreakmail:
        condition: service_healthy
    image: mailcow/acme:latest
    dns:
      - ${IPV4_NETWORK:-172.22.1}.254
    environment:
      LOG_LINES: ${LOG_LINES:-9999}
      ACME_CONTACT: ${ACME_CONTACT:-}
      ADDITIONAL_SAN: ${ADDITIONAL_SAN}
      AUTODISCOVER_SAN: ${AUTODISCOVER_SAN:-y}
      PHREAKMAIL_HOSTNAME: ${PHREAKMAIL_HOSTNAME}
      DBNAME: ${DBNAME}
      DBUSER: ${DBUSER}
      DBPASS: ${DBPASS}
      SKIP_LETS_ENCRYPT: ${SKIP_LETS_ENCRYPT:-n}
      COMPOSE_PROJECT_NAME: ${COMPOSE_PROJECT_NAME:-phreakmail-dockerized}
      DIRECTORY_URL: ${DIRECTORY_URL:-}
      ENABLE_SSL_SNI: ${ENABLE_SSL_SNI:-n}
      SKIP_IP_CHECK: ${SKIP_IP_CHECK:-n}
      SKIP_HTTP_VERIFICATION: ${SKIP_HTTP_VERIFICATION:-n}
      ONLY_MAILCOW_HOSTNAME: ${ONLY_MAILCOW_HOSTNAME:-n}
      LE_STAGING: ${LE_STAGING:-n}
      TZ: ${TZ}
      KEYDB_SLAVEOF_IP: ${KEYDB_SLAVEOF_IP:-}
      KEYDB_SLAVEOF_PORT: ${KEYDB_SLAVEOF_PORT:-}
      KEYDBPASS: ${KEYDBPASS:-}
      SNAT_TO_SOURCE: ${SNAT_TO_SOURCE:-n}
      SNAT6_TO_SOURCE: ${SNAT6_TO_SOURCE:-n}
    volumes:
      - ./data/web/.well-known/acme-challenge:/var/www/acme:z
      - ./data/assets/ssl:/var/lib/acme/:z
      - ./data/assets/ssl-example:/var/lib/ssl-example/:ro,Z
      - mysql-socket-vol-1:/var/run/mysqld/
    restart: always
    networks:
      phreakmail-network:
        aliases:
          - acme

  netfilter-phreakmail:
    image: alpine:3.18
    command: >
      sh -c "apk add --no-cache iptables ip6tables &&
             while true; do sleep 3600; done"
    stop_grace_period: 30s
    restart: always
    privileged: true
    environment:
      TZ: ${TZ}
      IPV4_NETWORK: ${IPV4_NETWORK:-172.22.1}
      IPV6_NETWORK: ${IPV6_NETWORK:-fd4d:6169:6c63:6f77::/64}
      SNAT_TO_SOURCE: ${SNAT_TO_SOURCE:-n}
      SNAT6_TO_SOURCE: ${SNAT6_TO_SOURCE:-n}
      KEYDB_SLAVEOF_IP: ${KEYDB_SLAVEOF_IP:-}
      KEYDB_SLAVEOF_PORT: ${KEYDB_SLAVEOF_PORT:-}
      KEYDBPASS: ${KEYDBPASS:-}
      MAILCOW_REPLICA_IP: ${MAILCOW_REPLICA_IP:-}
      DISABLE_NETFILTER_ISOLATION_RULE: ${DISABLE_NETFILTER_ISOLATION_RULE:-n}
    network_mode: "host"
    volumes:
      - /lib/modules:/lib/modules:ro

  watchdog-phreakmail:
    image: alpine:3.18
    command: >
      sh -c "apk add --no-cache curl jq &&
             echo 'Watchdog service placeholder running...' &&
             while true; do sleep 3600; done"
    dns:
      - ${IPV4_NETWORK:-172.22.1}.254
    tmpfs:
      - /tmp
    volumes:
      - rspamd-vol-1:/var/lib/rspamd
      - mysql-socket-vol-1:/var/run/mysqld/
      - exim-vol-1:/var/spool/exim4
      - ./data/assets/ssl:/etc/ssl/mail/:ro,z
    restart: always
    depends_on:
      - exim-phreakmail
      - dovecot-phreakmail
      - mysql-phreakmail
      - acme-phreakmail
      - keydb-phreakmail
    environment:
      IPV6_NETWORK: ${IPV6_NETWORK:-fd4d:6169:6c63:6f77::/64}
      LOG_LINES: ${LOG_LINES:-9999}
      TZ: ${TZ}
      DBNAME: ${DBNAME}
      DBUSER: ${DBUSER}
      DBPASS: ${DBPASS}
      DBROOT: ${DBROOT}
      USE_WATCHDOG: ${USE_WATCHDOG:-n}
      WATCHDOG_NOTIFY_EMAIL: ${WATCHDOG_NOTIFY_EMAIL:-}
      WATCHDOG_NOTIFY_BAN: ${WATCHDOG_NOTIFY_BAN:-y}
      WATCHDOG_NOTIFY_START: ${WATCHDOG_NOTIFY_START:-y}
      WATCHDOG_SUBJECT: ${WATCHDOG_SUBJECT:-Watchdog ALERT}
      WATCHDOG_NOTIFY_WEBHOOK: ${WATCHDOG_NOTIFY_WEBHOOK:-}
      WATCHDOG_NOTIFY_WEBHOOK_BODY: ${WATCHDOG_NOTIFY_WEBHOOK_BODY:-}
      WATCHDOG_EXTERNAL_CHECKS: ${WATCHDOG_EXTERNAL_CHECKS:-n}
      WATCHDOG_MYSQL_REPLICATION_CHECKS: ${WATCHDOG_MYSQL_REPLICATION_CHECKS:-n}
      WATCHDOG_VERBOSE: ${WATCHDOG_VERBOSE:-n}
      PHREAKMAIL_HOSTNAME: ${PHREAKMAIL_HOSTNAME}
      COMPOSE_PROJECT_NAME: ${COMPOSE_PROJECT_NAME:-phreakmail-dockerized}
      IPV4_NETWORK: ${IPV4_NETWORK:-172.22.1}
      IP_BY_DOCKER_API: ${IP_BY_DOCKER_API:-0}
      CHECK_UNBOUND: ${CHECK_UNBOUND:-1}
      SKIP_CLAMD: ${SKIP_CLAMD:-n}
      SKIP_OLEFY: ${SKIP_OLEFY:-n}
      SKIP_LETS_ENCRYPT: ${SKIP_LETS_ENCRYPT:-n}
      SKIP_SOGO: ${SKIP_SOGO:-n}
      HTTPS_PORT: ${HTTPS_PORT:-443}
      KEYDB_SLAVEOF_IP: ${KEYDB_SLAVEOF_IP:-}
      KEYDB_SLAVEOF_PORT: ${KEYDB_SLAVEOF_PORT:-}
      KEYDBPASS: ${KEYDBPASS:-}
      EXTERNAL_CHECKS_THRESHOLD: ${EXTERNAL_CHECKS_THRESHOLD:-1}
      APACHE_THRESHOLD: ${APACHE_THRESHOLD:-5}
      KEYDB_THRESHOLD: ${KEYDB_THRESHOLD:-5}
      MYSQL_THRESHOLD: ${MYSQL_THRESHOLD:-5}
      MYSQL_REPLICATION_THRESHOLD: ${MYSQL_REPLICATION_THRESHOLD:-1}
      SOGO_THRESHOLD: ${SOGO_THRESHOLD:-3}
      POSTFIX_THRESHOLD: ${POSTFIX_THRESHOLD:-8}
      CLAMD_THRESHOLD: ${CLAMD_THRESHOLD:-15}
      DOVECOT_THRESHOLD: ${DOVECOT_THRESHOLD:-12}
      DOVECOT_REPL_THRESHOLD: ${DOVECOT_REPL_THRESHOLD:-20}
      PHPFPM_THRESHOLD: ${PHPFPM_THRESHOLD:-5}
      RATELIMIT_THRESHOLD: ${RATELIMIT_THRESHOLD:-1}
      FAIL2BAN_THRESHOLD: ${FAIL2BAN_THRESHOLD:-1}
      ACME_THRESHOLD: ${ACME_THRESHOLD:-1}
      RSPAMD_THRESHOLD: ${RSPAMD_THRESHOLD:-5}
      OLEFY_THRESHOLD: ${OLEFY_THRESHOLD:-5}
      MAILQ_THRESHOLD: ${MAILQ_THRESHOLD:-20}
      DOVECOT_REPL_THRESHOLD: ${DOVECOT_REPL_THRESHOLD:-20}
    networks:
      phreakmail-network:
        aliases:
          - watchdog

  dockerapi-phreakmail:
    image: alpine:3.18
    command: >
      sh -c "apk add --no-cache curl jq &&
             while true; do sleep 3600; done"
    security_opt:
      - label=disable
    restart: always
    dns:
      - ${IPV4_NETWORK:-172.22.1}.254
    environment:
      DBROOT: ${DBROOT}
      TZ: ${TZ}
      KEYDB_SLAVEOF_IP: ${KEYDB_SLAVEOF_IP:-}
      KEYDB_SLAVEOF_PORT: ${KEYDB_SLAVEOF_PORT:-}
      KEYDBPASS: ${KEYDBPASS:-}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      phreakmail-network:
        aliases:
          - dockerapi

  comodo-phreakmail:
    image: tecnativa/comodo-cav:latest
    restart: always
    volumes:
      - comodo-db-vol-1:/var/lib/comodo
      - ./data/conf/comodo:/etc/comodo:Z
    environment:
      TZ: ${TZ}
      SKIP_COMODO: ${SKIP_COMODO:-n}
    networks:
      phreakmail-network:
        aliases:
          - comodo

  olefy-phreakmail:
    image: python:3.9-slim
    restart: always
    command: >
      sh -c "pip install --no-cache-dir oletools &&
             echo 'Olefy service placeholder running...' &&
             while true; do sleep 3600; done"
    environment:
      TZ: ${TZ}
      OLEFY_BINDADDRESS: 0.0.0.0
      OLEFY_BINDPORT: 10055
      OLEFY_TMPDIR: /tmp
      OLEFY_PYTHON_PATH: /usr/bin/python3
      OLEFY_OLEVBA_PATH: /usr/bin/olevba
      OLEFY_LOGLVL: 20
      OLEFY_MINLENGTH: 500
      OLEFY_DEL_TMP: 1
      SKIP_OLEFY: ${SKIP_OLEFY:-n}
    networks:
      phreakmail-network:
        aliases:
          - olefy

  ofelia-phreakmail:
    image: mcuadros/ofelia:latest
    restart: always
    command: daemon --docker -f label=com.docker.compose.project=${COMPOSE_PROJECT_NAME}
    environment:
      TZ: ${TZ}
      COMPOSE_PROJECT_NAME: ${COMPOSE_PROJECT_NAME}
    depends_on:
      - dovecot-phreakmail
    labels:
      ofelia.enabled: "true"
    security_opt:
      - label=disable
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      phreakmail-network:
        aliases:
          - ofelia

  ipv6nat-phreakmail:
    depends_on:
      - unbound-phreakmail
      - mysql-phreakmail
      - keydb-phreakmail
      - comodo-phreakmail
      - rspamd-phreakmail
      - php-fpm-phreakmail
      - dovecot-phreakmail
      - exim-phreakmail
      - memcached-phreakmail
      - apache2-phreakmail
      - acme-phreakmail
      - netfilter-phreakmail
      - watchdog-phreakmail
      - dockerapi-phreakmail
    environment:
      TZ: ${TZ}
    image: robbertkl/ipv6nat
    security_opt:
      - label=disable
    restart: always
    privileged: true
    network_mode: "host"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /lib/modules:/lib/modules:ro

networks:
  phreakmail-network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-phreakmail
    enable_ipv6: true
    ipam:
      driver: default
      config:
        - subnet: ${IPV4_NETWORK:-172.22.1}.0/24
        - subnet: ${IPV6_NETWORK:-fd4d:6169:6c63:6f77::/64}

volumes:
  vmail-vol-1:
  vmail-index-vol-1:
  mysql-vol-1:
  mysql-socket-vol-1:
  keydb-vol-1:
  rspamd-vol-1:
  exim-vol-1:
  crypt-vol-1:
  comodo-db-vol-1:
  django-static:
